<script>
document.addEventListener("DOMContentLoaded", () => {

  /* DOM ELEMENTS (MISSING DEFINITIONS FIX) */
  const ageBox = document.getElementById("ageBox");
  const chat = document.getElementById("chat");
  const typing = document.getElementById("typing");
  const status = document.getElementById("status");
  const msg = document.getElementById("msg");
  const online = document.getElementById("online");
  const imageInput = document.getElementById("imageInput");
  const connectSound = document.getElementById("connectSound");
  const disconnectSound = document.getElementById("disconnectSound");

  /* AGE CHECK */
  if (localStorage.ageAccepted === "yes") {
    ageBox.style.display = "none";
  }
  window.acceptAge = function () {
    localStorage.ageAccepted = "yes";
    ageBox.style.display = "none";
  };

  /* SOCKET */
  const socket = io({ reconnection: true });

  let gender = "any";
  let imgCount = 0;
  let connected = false;

  /* GENDER */
  window.setGender = function (g) {
    gender = g;
    document.querySelectorAll(".gender button").forEach(b => b.classList.remove("active"));
    event.target.classList.add("active");
  };

  /* SOCKET EVENTS */
  socket.on("online-count", c => {
    if (online) online.innerText = c;
  });

  socket.on("waiting", () => {
    status.innerText = "ðŸ” Looking for stranger...";
    connected = false;
  });

  socket.on("connected", () => {
    status.innerText = "âœ… Connected to stranger";
    connected = true;
    connectSound && connectSound.play().catch(()=>{});
  });

  socket.on("partner-left", () => {
    status.innerText = "âŒ Stranger disconnected";
    connected = false;
    disconnectSound && disconnectSound.play().catch(()=>{});

    setTimeout(() => {
      status.innerText = "ðŸ”„ Reconnecting...";
      socket.emit("start-chat", gender);
    }, 1500);
  });

  socket.on("typing", () => {
    typing.innerText = "âœ Stranger is typing...";
    setTimeout(() => typing.innerText = "", 1200);
  });

  socket.on("message", m => addText("Stranger", m));
  socket.on("image", o => addImage("Stranger", o));
  socket.on("delete-image", id => document.getElementById(id)?.remove());

  /* START / NEXT */
  window.start = function () {
    chat.innerHTML = "";
    typing.innerText = "";
    socket.emit("start-chat", gender);
  };

  /* SEND MESSAGE */
  window.send = function () {
    if (!msg.value || !connected) return;
    socket.emit("message", msg.value);
    addText("You", msg.value);
    msg.value = "";
  };

  msg.addEventListener("input", () => {
    if (connected) socket.emit("typing");
  });

  /* IMAGE */
  window.pickImage = function () {
    if (!connected) return;
    imageInput.click();
  };

  imageInput.addEventListener("change", () => {
    const file = imageInput.files[0];
    if (!file || file.size > 1024 * 1024) {
      alert("Image must be under 1MB");
      return;
    }

    const reader = new FileReader();
    const id = "img_" + (++imgCount);

    reader.onload = () => {
      const data = { id, src: reader.result };
      socket.emit("image", data);
      addImage("You", data);
    };
    reader.readAsDataURL(file);
  });

  /* UI HELPERS */
  function addText(sender, text) {
    const d = document.createElement("div");
    d.className = "msg";
    d.innerHTML = "<b>" + sender + ":</b> " + text;
    chat.appendChild(d);
    chat.scrollTop = 99999;
  }

  function addImage(sender, o) {
    const d = document.createElement("div");
    d.className = "msg";
    d.id = o.id;
    d.innerHTML = "<b>" + sender + ":</b><br><img src='" + o.src + "'>";

    if (sender === "You") {
      const b = document.createElement("button");
      b.className = "del-btn";
      b.innerText = "âŒ Delete";
      b.onclick = () => {
        socket.emit("delete-image", o.id);
        d.remove();
      };
      d.appendChild(document.createElement("br"));
      d.appendChild(b);
    }

    chat.appendChild(d);
    chat.scrollTop = 99999;
  }

});
</script>
